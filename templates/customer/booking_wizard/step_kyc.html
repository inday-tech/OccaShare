{% extends "customer/booking_wizard/wizard_base.html" %}

{% block title %}Identity Verification - OccaServe{% endblock %}

{% block content %}
<div class="kyc-step">
    <h2 class="wizard-title">Identity Verification</h2>
    <p class="wizard-subtitle">We need to verify your identity to ensure a secure booking experience.</p>

    <div id="kyc-form-container">
        <!-- Phase 1: ID Upload -->
        <div id="step-id-upload" class="kyc-substep active">
            <div class="upload-zone" id="upload-zone" onclick="document.getElementById('id_document').click()">
                <i class="fas fa-id-card fa-3x"></i>
                <h3>Step 1: Upload Government ID</h3>
                <p>Ensure the ID is clear and readable (JPG or PNG)</p>
                <input type="file" id="id_document" style="display: none;" accept="image/*"
                    onchange="handleIdUpload(this)">
            </div>
            <div id="id-preview" class="image-preview" style="display: none;">
                <img id="id-image" src="" alt="ID Preview">
                <div class="preview-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetIdUpload()">Retake</button>
                    <button type="button" class="btn btn-primary" onclick="proceedToCamera()">Use this ID <i
                            class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <!-- Phase 2: Live Person Scanner -->
        <div id="scanner-container" class="kyc-substep" style="display: none;">
            <div class="scanner-header">
                <h3>Step 2: Liveliness Check</h3>
                <p>Position your face within the frame.</p>
            </div>
            <div class="scanner-viewport person-scanner">
                <video id="webcam" autoplay playsinline></video>
                <div class="scanner-overlay">
                    <div class="face-guide">
                        <div class="scanning-line" id="scan-line"></div>
                    </div>
                    <div id="scan-feedback" class="scan-feedback">Looking for face...</div>
                </div>
                <canvas id="frame-canvas" style="display: none;"></canvas>
            </div>

            <div class="liveliness-prompt" id="liveliness-prompt" style="display: none;">
                <div class="prompt-icon"><i class="fas fa-eye"></i></div>
                <div class="prompt-text">Blink your eyes to verify liveliness</div>
            </div>

            <div class="scanner-controls">
                <button type="button" class="btn btn-primary" id="btn-start-scan" onclick="startRealtimeScanner()">
                    <i class="fas fa-camera"></i> Start Liveliness Check
                </button>
            </div>
        </div>

        <!-- Step 3: Processing & Comparison -->
        <div id="step-processing" class="kyc-substep" style="display: none;">
            <div class="processing-status">
                <div class="spinner" id="processing-spinner"></div>
                <h3 id="status-text">Comparing ID with Face...</h3>
                <p id="status-subtext">This will only take a moment.</p>

                <div id="retry-container" style="display: none; margin-top: 2rem;">
                    <button type="button" class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-redo"></i> Try Again / Ulitin
                    </button>
                    <p style="margin-top: 1rem; font-size: 0.85rem; color: #64748b;">Please ensure your ID is clear and
                        your face is well-lit.</p>
                </div>

                <div class="comparison-preview">
                    <div class="prev-box">
                        <label>Uploaded ID</label>
                        <img id="comp-id" src="">
                    </div>
                    <div class="prev-box">
                        <label>Live Person</label>
                        <img id="comp-person" src="">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="wizard-actions">
        <a href="/bookings/step/details" class="btn-prev">
            <i class="fas fa-arrow-left"></i> Back to Details
        </a>
        <button type="button" id="btn-next" class="btn btn-primary" style="display: none;"
            onclick="window.location.href='/bookings/step/quotation/{{ booking_id }}'">
            Continue to Quotation <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<style>
    .upload-zone {
        border: 2px dashed var(--border-color);
        border-radius: 1.5rem;
        padding: 4rem 2rem;
        text-align: center;
        cursor: pointer;
        background: #f8fafc;
        transition: all 0.2s;
    }

    .upload-zone:hover {
        border-color: var(--primary-color);
        background: #f1f5f9;
    }

    .upload-zone i {
        color: var(--primary-color);
        margin-bottom: 1.5rem;
    }

    .image-preview {
        text-align: center;
        margin-top: 2rem;
    }

    .image-preview img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 1rem;
        box-shadow: var(--shadow-lg);
    }

    .preview-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .scanner-viewport {
        position: relative;
        width: 300px;
        height: 300px;
        background: #000;
        margin: 0 auto 1.5rem;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid var(--primary-color);
        box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.3);
    }

    #webcam {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        z-index: 10;
    }

    .face-guide {
        width: 70%;
        height: 80%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-radius: 50% / 60% 60% 40% 40%;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4);
        position: relative;
    }

    /* Scanning Line Animation */
    .scanning-line {
        position: absolute;
        width: 100%;
        height: 4px;
        background: var(--primary-color);
        box-shadow: 0 0 15px var(--primary-color);
        top: 0;
        left: 0;
        animation: scanMove 2.5s infinite ease-in-out;
        z-index: 20;
        display: none;
    }

    @keyframes scanMove {
        0% {
            top: 0%;
            opacity: 0;
        }

        10% {
            opacity: 1;
        }

        90% {
            opacity: 1;
        }

        100% {
            top: 100%;
            opacity: 0;
        }
    }

    .scanner-header h3 {
        color: var(--slate-900);
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .scanner-header p {
        color: var(--slate-500);
        font-size: 0.95rem;
    }

    .comparison-preview {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        margin-top: 2rem;
        animation: slideUp 0.4s ease-out;
    }

    .prev-box {
        text-align: center;
        padding: 0.5rem;
        background: #fff;
        border-radius: 1rem;
        box-shadow: var(--shadow-sm);
    }

    .prev-box img {
        width: 140px;
        height: 140px;
        object-fit: cover;
        border-radius: 0.8rem;
        border: 2px solid #e2e8f0;
    }

    .prev-box label {
        display: block;
        font-size: 0.75rem;
        margin-top: 0.5rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
    }

    .scan-feedback {
        position: absolute;
        bottom: 2rem;
        color: #fff;
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(4px);
        padding: 0.6rem 1.2rem;
        border-radius: 2rem;
        font-size: 0.85rem;
        font-weight: 500;
        letter-spacing: 0.02em;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .liveliness-prompt {
        text-align: center;
        margin-bottom: 1.5rem;
        background: #ecfdf5;
        padding: 1rem;
        border-radius: 1rem;
        border: 2px solid #10b981;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.02);
        }

        100% {
            transform: scale(1);
        }
    }

    .scanner-controls {
        text-align: center;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 2rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let bookingId = "{{ booking_id }}";
    let stream = null;
    let capturedIdBase64 = null;
    let capturedPersonBase64 = null;

    function handleIdUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                capturedIdBase64 = e.target.result;
                document.getElementById('id-image').src = capturedIdBase64;
                document.getElementById('upload-zone').style.display = 'none';
                document.getElementById('id-preview').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function resetIdUpload() {
        capturedIdBase64 = null;
        document.getElementById('id-preview').style.display = 'none';
        document.getElementById('upload-zone').style.display = 'block';
        document.getElementById('id_document').value = '';
    }

    function proceedToCamera() {
        document.getElementById('step-id-upload').style.display = 'none';
        document.getElementById('scanner-container').style.display = 'block';
    }

    async function startRealtimeScanner() {
        const video = document.getElementById('webcam');
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            document.getElementById('btn-start-scan').style.display = 'none';
            document.getElementById('liveliness-prompt').style.display = 'block';

            // Show scanning line
            document.getElementById('scan-line').style.display = 'block';
            document.getElementById('scan-feedback').innerText = "Analyzing Biometrics...";

            // Auto capture after 3.5 seconds
            setTimeout(capturePerson, 3500);
        } catch (err) {
            alert("Camera access denied: " + err);
        }
    }

    function capturePerson() {
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('frame-canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        capturedPersonBase64 = canvas.toDataURL('image/jpeg', 0.9);

        // Hide scanning line but keep video for a split second
        document.getElementById('scan-line').style.display = 'none';
        document.getElementById('scan-feedback').innerText = "Capture Complete";

        // Stop camera after capture
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }

        verifyMatch();
    }

    async function verifyMatch() {
        document.getElementById('scanner-container').style.display = 'none';
        document.getElementById('step-processing').style.display = 'block';

        // Show previews in comparison results
        document.getElementById('comp-id').src = capturedIdBase64;
        document.getElementById('comp-person').src = capturedPersonBase64;

        updateStatus("Initializing Secure Comparison...", "Verifying data integrity...");

        setTimeout(async () => {
            updateStatus("Matching Face to ID...", "Analyzing biometric markers...");

            const formData = new FormData();
            formData.append('booking_id', bookingId);
            formData.append('id_image_base64', capturedIdBase64);
            formData.append('selfie_image_base64', capturedPersonBase64);

            try {
                const res = await fetch('/api/verify/compare-id-face', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    updateStatus("Identity Verified!", "Match score: " + (data.match_score * 100).toFixed(1) + "%");
                    alert("âœ… Verification Successful!\n\nID matched with live capture at " + (data.match_score * 100).toFixed(1) + "%.");

                    document.getElementById('btn-next').style.display = 'inline-block';
                    setTimeout(() => {
                        window.location.href = `/bookings/step/quotation/${bookingId}`;
                    }, 2000);
                } else {
                    handleRejection(data.message);
                }
            } catch (err) {
                handleRejection("Network error. Please try again.");
            }
        }, 1500);
    }

    function updateStatus(title, sub) {
        document.getElementById('status-text').innerText = title;
        document.getElementById('status-subtext').innerText = sub;
    }

    function handleRejection(msg) {
        document.getElementById('processing-spinner').style.display = 'none';
        document.getElementById('retry-container').style.display = 'block';

        updateStatus("Security Rejection", msg);

        // Add error color to status text
        document.getElementById('status-text').style.color = "#dc2626";
    }
</script>
{% endblock %}