{% extends "customer/layout.html" %}

{% block title %}Overview - OccaServe Dashboard{% endblock %}

{% block extra_js %}
<script>
    // Dashboard-specific WebSocket client for booking updates
    const dashboardClientId = "{{ client_id }}";
    if (dashboardClientId) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const dashWs = new WebSocket(`${protocol}//${window.location.host}/ws/${dashboardClientId}`);

        dashWs.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.type === 'booking_update') {
                alert("Real-time Update: " + data.message);
                setTimeout(() => window.location.reload(), 2000);
            }
        };
    }
</script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Welcome back, {{ user.first_name }}!</h1>
    <p>Here's what's happening with your bookings today.</p>
</div>

{% if not user.is_verified %}
<!-- Unverified Alert -->
<div
    style="background: #fffbeb; border: 1px solid #fef3c7; border-radius: 1.5rem; padding: 1.5rem; margin-bottom: 2.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1.5rem; box-shadow: var(--shadow-sm);">
    <div style="display: flex; align-items: center; gap: 1.25rem;">
        <div
            style="width: 48px; height: 48px; border-radius: 50%; background: #fef3c7; display: flex; align-items: center; justify-content: center; color: #d97706; font-size: 1.25rem;">
            <i class="fas fa-id-card"></i>
        </div>
        <div>
            <h4 style="margin: 0; color: #92400e;">Account Verification Required</h4>
            <p style="margin: 0; font-size: 0.9rem; color: #b45309;">Complete your one-time identity verification to
                start booking caterers.</p>
        </div>
    </div>
    <a href="/customer/verification" class="btn-primary"
        style="white-space: nowrap; padding: 0.75rem 1.5rem; background: #d97706; border-color: #d97706;">Verify Now</a>
</div>
{% endif %}

<!-- Stats Cards -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 2rem; margin-bottom: 3.5rem;">
    <div
        style="background: var(--white); padding: 2rem; border-radius: 1.5rem; border: 1px solid var(--border-color); position: relative; overflow: hidden; box-shadow: var(--shadow-sm);">
        <i class="fas fa-calendar-alt"
            style="position: absolute; top: 1.5rem; right: 1.5rem; font-size: 2.5rem; opacity: 0.1; color: var(--primary-color);"></i>
        <div
            style="color: var(--text-light); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
            Upcoming Events</div>
        <div style="font-size: 2.5rem; font-weight: 700; color: var(--secondary-color);">{{ upcoming_count }}</div>
    </div>

    <div
        style="background: var(--white); padding: 2rem; border-radius: 1.5rem; border: 1px solid var(--border-color); position: relative; overflow: hidden; box-shadow: var(--shadow-sm);">
        <i class="fas fa-history"
            style="position: absolute; top: 1.5rem; right: 1.5rem; font-size: 2.5rem; opacity: 0.1; color: var(--primary-color);"></i>
        <div
            style="color: var(--text-light); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
            Total Bookings</div>
        <div style="font-size: 2.5rem; font-weight: 700; color: var(--secondary-color);">{{ total_count }}</div>
    </div>

    <div
        style="background: var(--white); padding: 2rem; border-radius: 1.5rem; border: 1px solid var(--border-color); position: relative; overflow: hidden; box-shadow: var(--shadow-sm);">
        <i class="fas fa-star"
            style="position: absolute; top: 1.5rem; right: 1.5rem; font-size: 2.5rem; opacity: 0.1; color: var(--primary-color);"></i>
        <div
            style="color: var(--text-light); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
            Reviews Given</div>
        <div style="font-size: 2.5rem; font-weight: 700; color: var(--secondary-color);">{{ user.reviews|length }}</div>
    </div>
</div>

<!-- Recent Activity -->
<div
    style="background: var(--white); border-radius: 2rem; padding: 2.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--border-color);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h3 style="font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem;"><i class="fas fa-clock"></i>
            Recent Events</h3>
        <a href="/customer/bookings" class="btn-text-arrow">View All <i class="fas fa-arrow-right"></i></a>
    </div>

    {% if bookings %}
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: separate; border-spacing: 0 1rem;">
            <thead>
                <tr
                    style="text-align: left; color: var(--text-light); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em;">
                    <th style="padding: 0 1.5rem;">Caterer</th>
                    <th style="padding: 0 1.5rem;">Date</th>
                    <th style="padding: 0 1.5rem;">Amount</th>
                    <th style="padding: 0 1.5rem;">Status</th>
                    <th style="padding: 0 1.5rem; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr style="background: var(--background-light); border-radius: 1rem; transition: all 0.3s ease;"
                    onmouseover="this.style.background='var(--background-soft)'"
                    onmouseout="this.style.background='var(--background-light)'">
                    <td style="padding: 1.5rem; border-radius: 1rem 0 0 1rem;">
                        <div style="display: flex; align-items: center; gap: 1.25rem;">
                            <div
                                style="width: 40px; height: 40px; border-radius: 12px; background: var(--background-soft); display: flex; align-items: center; justify-content: center; color: var(--primary-color);">
                                <i class="fas fa-magic"></i>
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 1.05rem; color: var(--secondary-color);">{{
                                    booking.event_name }}</h4>
                                <span style="font-size: 0.8rem; color: var(--text-light);">with {{ booking.caterer_name
                                    }}</span>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 1.5rem; color: var(--text-light);">
                        <div style="font-size: 0.95rem; font-weight: 600; color: var(--secondary-color);">
                            {{ booking.display_date }}
                        </div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">
                            {{ booking.display_time }}
                        </div>
                    </td>
                    <td style="padding: 1.5rem;">
                        <div style="font-weight: 700; color: var(--secondary-color);">
                            {{ booking.display_amount }}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-light);">
                            {{ booking.payment_method }}
                        </div>
                    </td>
                    <td style="padding: 1.5rem;">
                        <!-- Booking Status -->
                        {% set status_colors = {
                        'pending': 'background: #fef3c7; color: #92400e;',
                        'confirmed': 'background: #dcfce7; color: #166534;',
                        'completed': 'background: #dbeafe; color: #1e40af;',
                        'cancelled': 'background: #fee2e2; color: #991b1b;'
                        } %}
                        <div
                            style="padding: 0.4rem 0.8rem; border-radius: 2rem; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; margin-bottom: 0.4rem; {{ status_colors.get(booking.status or 'pending', 'background: #f1f5f9; color: #475569;') }}">
                            {{ booking.status or 'pending' }}
                        </div>
                        <br>
                        <!-- Payment Status -->
                        {% set pay_colors = {
                        'pending': 'color: #f59e0b;',
                        'paid': 'color: #10b981;',
                        'deposit_paid': 'color: #3b82f6;'
                        } %}
                        <span
                            style="font-size: 0.7rem; font-weight: 600; {{ pay_colors.get(booking.payment_status, 'color: #64748b;') }}">
                            <i class="fas fa-circle" style="font-size: 0.5rem; margin-right: 0.25rem;"></i>
                            {{ (booking.payment_status or 'pending')|replace('_', ' ')|upper }}
                        </span>
                    </td>
                    <td style="padding: 1.5rem; border-radius: 0 1rem 1rem 0; text-align: right;">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <a href="#" class="btn-icon"
                                style="width: 35px; height: 35px; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid var(--border-color); color: var(--text-light); transition: all 0.2s;"
                                onmouseover="this.style.color='var(--primary-color)'; this.style.borderColor='var(--primary-color)'"
                                onmouseout="this.style.color='var(--text-light)'; this.style.borderColor='var(--border-color)'"><i
                                    class="fas fa-eye"></i></a>
                            <a href="#" class="btn-icon"
                                style="width: 35px; height: 35px; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid var(--border-color); color: var(--text-light); transition: all 0.2s;"
                                onmouseover="this.style.color='var(--primary-color)'; this.style.borderColor='var(--primary-color)'"
                                onmouseout="this.style.color='var(--text-light)'; this.style.borderColor='var(--border-color)'"><i
                                    class="fas fa-comment"></i></a>
                            {% if booking.status == 'completed' and not booking.has_review %}
                            <a href="/customer/feedback/{{ booking.id }}" class="btn-primary"
                                style="padding: 0.4rem 0.8rem; font-size: 0.75rem; border-radius: 0.5rem; white-space: nowrap;">Rate
                                Service</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 4rem;">
        <img src="https://illustrations.popsy.co/gray/calendar.svg" alt="Empty"
            style="width: 180px; margin-bottom: 2rem; opacity: 0.5;">
        <h3 style="color: var(--text-light); margin-bottom: 0.5rem;">No bookings found</h3>
        <p style="color: var(--text-light); margin-bottom: 2rem;">Host your first event with OccaServe!</p>
        <a href="/caterers" class="btn-primary">Find a Caterer</a>
    </div>
    {% endif %}
</div>
{% endblock %}