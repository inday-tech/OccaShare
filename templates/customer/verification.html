{% extends "customer/layout.html" %}

{% block title %}Identity Verification - OccaServe{% endblock %}

{% block content %}
<div class="page-header" style="text-align: center; margin-bottom: 3rem;">
    <h1>Account Verification</h1>
    <p>Secure your account with a one-time identity check.</p>
</div>

<div style="max-width: 800px; margin: 0 auto;">
    <div
        style="background: white; border-radius: 2rem; padding: 3rem; box-shadow: var(--shadow-md); border: 1px solid var(--border-color);">

        {% if error %}
        <div
            style="background: #fef2f2; border: 1px solid #fee2e2; color: #991b1b; padding: 1.25rem; border-radius: 1rem; margin-bottom: 2.5rem; display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-exclamation-circle"></i>
            <span>{{ error }}</span>
        </div>
        {% endif %}

        <form action="/customer/verification/process" method="POST" enctype="multipart/form-data" id="verificationForm">
            <input type="hidden" name="client_id" value="{{ client_id }}">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2.5rem; margin-bottom: 3rem;">
                <!-- ID Upload -->
                <div>
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary-color);"><i
                            class="fas fa-id-card" style="margin-right: 0.5rem; color: var(--primary-color);"></i> 1.
                        Government ID</h3>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1.5rem;">Upload a clear photo
                        of your valid government-issued ID.</p>

                    <div id="id-dropzone"
                        style="border: 2px dashed var(--border-color); border-radius: 1.5rem; padding: 2.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--background-light);"
                        onclick="document.getElementById('id_document').click()"
                        onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='white'"
                        onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--background-light)'">
                        <i class="fas fa-cloud-upload-alt"
                            style="font-size: 2.5rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                        <p id="id-filename" style="font-weight: 500; font-size: 0.9rem; color: var(--text-dark);">Click
                            to select document</p>
                        <span style="font-size: 0.75rem; color: var(--text-light);">JPG, PNG or PDF (Max 5MB)</span>
                        <input type="file" name="id_document" id="id_document" style="display: none;"
                            onchange="handleFileSelect(this, 'id-filename', 'id-dropzone')">
                    </div>
                </div>

                <!-- Liveness Detection -->
                <div>
                    <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--secondary-color);"><i
                            class="fas fa-face-smile" style="margin-right: 0.5rem; color: var(--primary-color);"></i> 2.
                        Liveness Check</h3>
                    <p style="font-size: 0.85rem; color: var(--text-light); margin-bottom: 1.5rem;">Take a real-time
                        photo of yourself to confirm you are present.</p>

                    <div id="selfie-dropzone"
                        style="border: 2px dashed var(--border-color); border-radius: 1.5rem; padding: 2.5rem; text-align: center; cursor: pointer; transition: all 0.3s ease; background: var(--background-light);"
                        onclick="document.getElementById('selfie').click()"
                        onmouseover="this.style.borderColor='var(--primary-color)'; this.style.background='white'"
                        onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='var(--background-light)'">
                        <i class="fas fa-camera"
                            style="font-size: 2.5rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                        <p id="selfie-filename" style="font-weight: 500; font-size: 0.9rem; color: var(--text-dark);">
                            Capture a selfie</p>
                        <span style="font-size: 0.75rem; color: var(--text-light);">Real-time face verification</span>
                        <input type="file" name="selfie" id="selfie" capture="user" style="display: none;"
                            onchange="handleFileSelect(this, 'selfie-filename', 'selfie-dropzone')">
                    </div>
                </div>
            </div>

            <div id="processing-view" style="display: none; text-align: center; margin-bottom: 2rem;">
                <div class="loader" style="margin: 0 auto 1.5rem;"></div>
                <h4 id="status-text" style="color: var(--primary-color);">Analyzing Document...</h4>
                <p style="font-size: 0.85rem; color: var(--text-light);">Please do not refresh the page.</p>
            </div>

            <button type="submit" id="submit-btn" class="btn-primary"
                style="width: 100%; padding: 1.25rem; font-size: 1.1rem; border-radius: 1.25rem;">
                Submit for Verification
            </button>
        </form>
    </div>

    <div
        style="margin-top: 2rem; display: flex; gap: 1rem; align-items: flex-start; padding: 1.5rem; background: #f0f9ff; border-radius: 1.25rem; color: #0369a1;">
        <i class="fas fa-shield-halved" style="font-size: 1.5rem; margin-top: 0.25rem;"></i>
        <div>
            <h4 style="margin: 0 0 0.25rem 0;">Privacy & Security</h4>
            <p style="margin: 0; font-size: 0.85rem; line-height: 1.5;">Your data is encrypted and securely processed.
                We use industrial-grade OCR and Liveness detection to prevent fraud and ensure platform safety.</p>
        </div>
    </div>
</div>

<style>
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    let ws;
    const clientId = "{{ client_id }}";

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${protocol}//${window.location.host}/customer/verification/ws/${clientId}`);

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.type === 'verification_update') {
                const statusText = document.getElementById('status-text');
                statusText.innerText = data.message;

                if (data.status === 'success') {
                    statusText.style.color = 'var(--primary-color)';
                } else if (data.status === 'error') {
                    statusText.style.color = '#991b1b';
                }
            }
        };

        ws.onclose = function () {
            console.log('WebSocket connection closed');
        };
    }

    function handleFileSelect(input, textId, dropzoneId) {
        const text = document.getElementById(textId);
        const dropzone = document.getElementById(dropzoneId);
        if (input.files && input.files[0]) {
            text.innerText = input.files[0].name;
            text.style.color = 'var(--primary-color)';
            dropzone.style.borderColor = 'var(--primary-color)';
            dropzone.style.background = 'white';
        }
    }

    document.getElementById('verificationForm').onsubmit = function () {
        const idInput = document.getElementById('id_document');
        const selfieInput = document.getElementById('selfie');

        if (!idInput.files[0] || !selfieInput.files[0]) {
            alert('Please select both your ID and a selfie.');
            return false;
        }

        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('processing-view').style.display = 'block';

        connectWebSocket();
        return true;
    };
</script>
{% endblock %}